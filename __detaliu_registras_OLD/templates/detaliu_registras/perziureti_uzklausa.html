{% extends "base.html" %}
{% block title %}Užklausa #{{ uzklausa.pk }}{% endblock %}

{% block content %}
<div class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin:16px 0 12px">
    <h1 style="margin:0">Užklausa #{{ uzklausa.pk }}</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="{% url 'detaliu_registras:redaguoti_uzklausa' uzklausa.pk %}">Redaguoti</a>
      <a class="btn" href="{% url 'detaliu_registras:redaguoti_kaina' uzklausa.pk %}">Redaguoti kainą</a>
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:uzklausa_list' %}">Atgal</a>
    </div>
  </header>

  <!-- Pagrindinė informacija (paliekam visada atidarytą) -->
  <section class="box">
    <h3 style="margin:0 0 10px">Pagrindinė informacija</h3>
    <div class="grid">
      <div><strong>Klientas:</strong> {% firstof uzklausa.klientas.vardas uzklausa.klientas "—" %}</div>
      <div><strong>Projektas:</strong> {{ uzklausa.projektas|default:"—" }}</div>
      <div><strong>Detalė:</strong> {{ uzklausa.detale.pavadinimas|default:"—" }}</div>
      <div><strong>Brėžinio nr.:</strong> {{ uzklausa.detale.brezinio_nr|default:"—" }}</div>
      <div><strong>Data:</strong> {{ uzklausa.data|date:"Y-m-d" }}</div>
      <div style="grid-column:1/-1"><strong>Pastabos:</strong> {{ uzklausa.pastabos|default:"—" }}</div>
    </div>
  </section>

  <!-- Specifikacija -->
  <section class="box blk" data-key="spec">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Specifikacija</h3>
      <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
    </div>
    <div class="blk-body" style="margin-top:10px">
      {% with s=uzklausa.detale.specifikacija %}
        {% if s %}
          <div class="grid">
            <div><strong>Metalas:</strong> {{ s.metalas|default:"—" }}</div>
            <div><strong>Plotas m²:</strong> {% if s.plotas_m2 or s.plotas_m2 == 0 %}{{ s.plotas_m2 }}{% else %}—{% endif %}</div>
            <div><strong>Svoris kg:</strong> {% if s.svoris_kg or s.svoris_kg == 0 %}{{ s.svoris_kg }}{% else %}—{% endif %}</div>
            <div><strong>Medžiagos kodas:</strong> {{ s.medziagos_kodas|default:"—" }}</div>
          </div>
        {% else %}
          —
        {% endif %}
      {% endwith %}
    </div>
  </section>

  <!-- Paviršių dangos -->
  <section class="box blk" data-key="dangos">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Paviršių dangos</h3>
      <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
    </div>
    <div class="blk-body" style="margin-top:10px">
      {% with d=uzklausa.detale.pavirsiu_dangos %}
        {% if d %}
          <div class="grid">
            <div><strong>KTL / e-coating:</strong> {{ d.ktl_ec_name|default:"—" }}</div>
            <div><strong>Miltelinis:</strong> {{ d.miltelinis_name|default:"—" }}</div>
            <div><strong>RAL / spalva:</strong> {{ d.spalva_ral|default:"—" }}</div>
            <div><strong>Blizgumas / tekstūra:</strong> {{ d.blizgumas|default:"—" }}</div>
          </div>
        {% else %}
          —
        {% endif %}
      {% endwith %}
    </div>
  </section>

  <!-- Papildomi duomenys -->
  <section class="box blk" data-key="extra">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Papildomi duomenys</h3>
      <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
    </div>
    <div class="blk-body" style="margin-top:10px">
      <div class="grid">
        <div>
          <strong>Kiekiai:</strong><br>
          {% with d=uzklausa.detale %}
            {% if d.kiekis_metinis or d.kiekis_menesis or d.kiekis_partijai or d.kiekis_per_val %}
              {% if d.kiekis_metinis %}Metinis: {{ d.kiekis_metinis }}<br>{% endif %}
              {% if d.kiekis_menesis %}Mėnesio: {{ d.kiekis_menesis }}<br>{% endif %}
              {% if d.kiekis_partijai %}Partijai: {{ d.kiekis_partijai }}<br>{% endif %}
              {% if d.kiekis_per_val %}Per val.: {{ d.kiekis_per_val }}{% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </div>
        <div>
          <strong>Matmenys:</strong><br>
          {% with d=uzklausa.detale %}
            {% if d.ilgis_mm or d.plotis_mm or d.aukstis_mm or d.skersmuo_mm or d.storis_mm %}
              {% if d.ilgis_mm %}Ilgis: {{ d.ilgis_mm }} mm<br>{% endif %}
              {% if d.plotis_mm %}Plotis: {{ d.plotis_mm }} mm<br>{% endif %}
              {% if d.aukstis_mm %}Aukštis: {{ d.aukstis_mm }} mm<br>{% endif %}
              {% if d.skersmuo_mm %}Skersmuo: {{ d.skersmuo_mm }} mm<br>{% endif %}
              {% if d.storis_mm %}Storis: {{ d.storis_mm }} mm{% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </div>
        <div>
          <strong>Kabinimas:</strong><br>
          {% with d=uzklausa.detale %}
            {% if d.kabinimo_budas or d.kabliuku_kiekis or d.kabinimo_anga_mm or d.kabinti_per %}
              {% if d.kabinimo_budas %}Būdas: {{ d.kabinimo_budas }}<br>{% endif %}
              {% if d.kabliuku_kiekis %}Kabliukų: {{ d.kabliuku_kiekis }}<br>{% endif %}
              {% if d.kabinimo_anga_mm %}Anga: {{ d.kabinimo_anga_mm }} mm<br>{% endif %}
              {% if d.kabinti_per %}Kabinti per: {{ d.kabinti_per }}{% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </div>
        <div>
          <strong>Pakuotė:</strong><br>
          {% with d=uzklausa.detale %}
            {% if d.pakuotes_tipas or d.vienetai_dezeje or d.vienetai_paleje or d.pakuotes_pastabos %}
              {% if d.pakuotes_tipas %}Tipas: {{ d.pakuotes_tipas }}<br>{% endif %}
              {% if d.vienetai_dezeje %}Vnt. dėžėje: {{ d.vienetai_dezeje }}<br>{% endif %}
              {% if d.vienetai_paleje %}Vnt. palėje: {{ d.vienetai_paleje }}<br>{% endif %}
              {% if d.pakuotes_pastabos %}Pastabos: {{ d.pakuotes_pastabos }}{% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </div>
        <div style="grid-column:1/-1">
          <strong>Testai / kokybė:</strong><br>
          {% with d=uzklausa.detale %}
            {% if d.testai_druskos_rukas_val or d.testas_adhezija or d.testas_storis_mikronai or d.testai_kita %}
              {% if d.testai_druskos_rukas_val %}Druskos rūkas: {{ d.testai_druskos_rukas_val }} val<br>{% endif %}
              {% if d.testas_adhezija %}Adhezija: {{ d.testas_adhezija }}<br>{% endif %}
              {% if d.testas_storis_mikronai %}Storis: {{ d.testas_storis_mikronai }} μm<br>{% endif %}
              {% if d.testai_kita %}Kita: {{ d.testai_kita }}{% endif %}
            {% else %}—{% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </section>

  <!-- Kainos -->
  <section class="box blk" data-key="kainos">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Kainos</h3>
      <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
    </div>
    <div class="blk-body" style="margin-top:10px">
      {% if kaina_aktuali %}
        <div><strong>Aktuali:</strong> {{ kaina_aktuali }}</div>
      {% else %}
        <div>—</div>
      {% endif %}
      {% if kainos %}
        <div style="margin-top:8px;color:#6b7280">Visos:</div>
        <ul style="margin:6px 0 0 16px">
          {% for k in kainos %}
            <li>{{ k }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </section>

  <!-- Brėžiniai -->
  <section class="box blk" data-key="brez">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Brėžiniai</h3>
      <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
    </div>
    <div class="blk-body" style="margin-top:10px">
      {% with br=uzklausa.detale.breziniai.all %}
        {% if br %}
          <ul style="list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
            {% for b in br %}
              <li style="border:1px solid #e5e7eb;border-radius:8px;padding:8px;background:#fff">
                <div style="font-weight:600">{{ b.pavadinimas|default:"Brėžinys" }}</div>

                {% if b.failas or b.isorinis_url %}
                  {% if b.tipas == "img" %}
                    <a href="{{ b.failas.url|default:b.isorinis_url }}" target="_blank" rel="noopener">
                      <img src="{{ b.failas.url|default:b.isorinis_url }}" alt="" style="max-width:100%;height:auto;border-radius:6px;margin-top:6px">
                    </a>
                  {% else %}
                    <a class="btn" href="{{ b.failas.url|default:b.isorinis_url }}" target="_blank" rel="noopener">
                      Atverti ({{ b.tipas|upper }})
                    </a>
                  {% endif %}
                {% endif %}

                {% if b.versija %}<div style="color:#6b7280;margin-top:6px">Versija: {{ b.versija }}</div>{% endif %}
                <div style="color:#6b7280;margin-top:6px">Tipas: {{ b.tipas|upper }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          —
        {% endif %}
      {% endwith %}
    </div>
  </section>

  <!-- ISTORIJA (lazy load) -->
  <section class="box blk" data-key="history" id="history-box">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">Istorija</h3>
      <div style="display:flex;gap:8px">
        <button id="history-toggle" class="btn btn-secondary" type="button">Įkelti</button>
        <button type="button" class="btn btn-secondary blk-toggle">Slėpti</button>
      </div>
    </div>
    <div class="blk-body" style="margin-top:10px; display:block">
      <div id="history-content" style="display:none"></div>
    </div>
  </section>

  <script>
  (function(){
    // --- Rodyti/Slėpti blokai su prisiminimu ---
    const pk = {{ uzklausa.pk|default:0 }};
    const KEY = (k)=>`uzkl:${pk}:blk:${k}`;
    document.querySelectorAll('.blk').forEach(sec=>{
      const key = sec.getAttribute('data-key') || 'blk';
      const body = sec.querySelector('.blk-body');
      const btn  = sec.querySelector('.blk-toggle');
      if(!body || !btn) return;

      // atstatom būseną iš localStorage (default atidaryta)
      let state = localStorage.getItem(KEY(key)) || 'open';
      if(state === 'closed'){ body.style.display = 'none'; btn.textContent = 'Rodyti'; }
      else { body.style.display = ''; btn.textContent = 'Slėpti'; }

      btn.addEventListener('click', ()=>{
        const isHidden = (body.style.display === 'none');
        if(isHidden){ body.style.display=''; btn.textContent='Slėpti'; localStorage.setItem(KEY(key),'open'); }
        else { body.style.display='none'; btn.textContent='Rodyti'; localStorage.setItem(KEY(key),'closed'); }
      });
    });

    // --- Istorijos lazy-load ---
    const hBtn  = document.getElementById('history-toggle');
    const hWrap = document.getElementById('history-content');
    if(hBtn && hWrap){
      let loaded=false;
      const url = "{% url 'detaliu_registras_history:history_partial' uzklausa.pk 'Uzklausa' uzklausa.pk %}?limit=20";
      hBtn.addEventListener('click', async function(){
        if(loaded){ // pakartotinis paspaudimas – perjungiam rodyti/slėpti
          hWrap.style.display = (hWrap.style.display==='none') ? '' : 'none';
          this.textContent = (hWrap.style.display==='none') ? 'Rodyti' : 'Slėpti';
          return;
        }
        try{
          const r = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          hWrap.innerHTML = await r.text();
          hWrap.style.display = '';
          this.textContent = 'Slėpti';
          loaded = true;
        }catch(e){
          hWrap.innerHTML = '<div class="flash flash-error">Nepavyko įkelti istorijos.</div>';
          hWrap.style.display = '';
          this.textContent = 'Slėpti';
        }
      });

      // palaikom "Rodyti daugiau" nuorodas partiale (be reload)
      document.addEventListener('click', async function(ev){
        const a = ev.target.closest('.js-history-link');
        if(!a || !hWrap.contains(a)) return;
        ev.preventDefault();
        try{
          const r = await fetch(a.href, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          hWrap.innerHTML = await r.text();
        }catch(_){}
      });
    }
  })();
  </script>

</div>
{% endblock %}
