{% extends "base.html" %}
{% load static %}
{% block title %}Kaina — {{ uzklausa|default:"Užklausa" }}{% endblock %}

{% block content %}
<div class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin:12px 0">
    <h1 style="margin:0">
      {% if kaina %}Redaguoti kainą{% else %}Pridėti kainą{% endif %}
    </h1>
    <div style="display:flex;gap:8px">
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:perziureti_uzklausa' uzklausa.pk %}">← Į užklausą</a>
    </div>
  </header>

  {% if messages %}
    {% for m in messages %}
      <div class="flash {% if m.tags %}flash-{{ m.tags }}{% endif %}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="flash flash-error" style="margin-bottom:10px">{{ form.non_field_errors }}</div>
  {% endif %}

  <div class="box" style="margin-top:8px">
    <form method="post" novalidate>
      {% csrf_token %}

      <div class="grid">
        <label class="field">
          <span>Suma</span>
          {{ form.suma }}
          {% if form.suma.errors %}<div class="err">{{ form.suma.errors|striptags }}</div>{% endif %}
        </label>

        <label class="field">
          <span>Valiuta</span>
          {{ form.valiuta }}
          {% if form.valiuta.errors %}<div class="err">{{ form.valiuta.errors|striptags }}</div>{% endif %}
        </label>

        <label class="field">
          <span>Būsena</span>
          {{ form.busena }}
          {% if form.busena.errors %}<div class="err">{{ form.busena.errors|striptags }}</div>{% endif %}
        </label>

        <label class="field" style="align-self:end;display:flex;flex-direction:row;gap:8px">
          {{ form.yra_fiksuota }} <span>Yra fiksuota?</span>
          {% if form.yra_fiksuota.errors %}<div class="err">{{ form.yra_fiksuota.errors|striptags }}</div>{% endif %}
        </label>

        <!-- Intervalinė kaina -->
        <div class="field js-int" data-role="interval">
          <span>Kiekis nuo</span>
          {{ form.kiekis_nuo }}
          {% if form.kiekis_nuo.errors %}<div class="err">{{ form.kiekis_nuo.errors|striptags }}</div>{% endif %}
        </div>

        <div class="field js-int" data-role="interval">
          <span>Kiekis iki</span>
          {{ form.kiekis_iki }}
          {% if form.kiekis_iki.errors %}<div class="err">{{ form.kiekis_iki.errors|striptags }}</div>{% endif %}
        </div>

        <!-- Fiksuota kaina -->
        <div class="field js-fix" data-role="fixed">
          <span>Fiksuotas kiekis</span>
          {{ form.fiksuotas_kiekis }}
          {% if form.fiksuotas_kiekis.errors %}<div class="err">{{ form.fiksuotas_kiekis.errors|striptags }}</div>{% endif %}
        </div>

        <div class="field js-fix" data-role="fixed">
          <span>Kainos matas</span>
          {{ form.kainos_matas }}
          {% if form.kainos_matas.errors %}<div class="err">{{ form.kainos_matas.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <p class="hint" style="margin-top:8px;color:#6b7280">
        Jei pažymėta <b>„Yra fiksuota“</b>, privalomi <b>Fiksuotas kiekis</b> ir <b>Kainos matas</b>.
        Jei nepažymėta — naudokite <b>Kiekis nuo</b>/<b>Kiekis iki</b>.
      </p>

      <div class="actions" style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" type="submit">Išsaugoti</button>
        <a class="btn btn-secondary" href="{% url 'detaliu_registras:perziureti_uzklausa' uzklausa.pk %}">Atšaukti</a>
      </div>
    </form>
  </div>

  <!-- Istorija -->
  <section class="box" style="margin-top:12px">
    <h3 style="margin-top:0">Kainos istorija</h3>
    {% if kainos_history %}
      <ul style="margin:8px 0 0 18px">
        {% for h in kainos_history %}
          <li>
            {{ h.history_date|date:"Y-m-d H:i" }} —
            {{ h.instance.suma }} {{ h.instance.valiuta }}
            {% if h.instance.yra_fiksuota %}
              (fiks. {{ h.instance.fiksuotas_kiekis }} {{ h.instance.kainos_matas }})
            {% else %}
              {% if h.instance.kiekis_nuo or h.instance.kiekis_iki %}
                ({{ h.instance.kiekis_nuo|default:"0" }}–{{ h.instance.kiekis_iki|default:"∞" }})
              {% endif %}
            {% endif %}
            — {{ h.history_user|default:"sistema" }}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="color:#6b7280">Istorijos įrašų dar nėra.</p>
    {% endif %}
  </section>
</div>

<style>
.container{max-width:960px;margin:0 auto;padding:0 16px}
.box{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin:12px 0;background:#fff}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select,.field textarea{padding:8px 10px;border:1px solid #d1d5db;border-radius:6px}
.err{color:#b91c1c;font-size:.9rem}
.hint{font-size:.9rem}
.flash{padding:8px 10px;border-radius:6px}
.flash-success{background:#ecfdf5;border:1px solid #10b981;color:#065f46}
.flash-error{background:#fef2f2;border:1px solid #ef4444;color:#991b1b}
</style>

<script>
(function(){
  const chk = document.getElementById('{{ form.yra_fiksuota.auto_id }}');
  const fixed = document.querySelectorAll('.js-fix');
  const interval = document.querySelectorAll('.js-int');

  function toggle(){
    const isFixed = chk && chk.checked;
    fixed.forEach(el => el.style.display = isFixed ? '' : 'none');
    interval.forEach(el => el.style.display = isFixed ? 'none' : '');
  }

  if (chk){
    chk.addEventListener('change', toggle);
    // Pirmas pritaikymas pagal esamą reikšmę
    toggle();
  }
})();
</script>
{% endblock %}
