{# pozicijos/templates/pozicijos/components/kainos_formset.html #}

<div class="kainos-formset" id="kainos-formset-{{ formset.prefix }}" data-prefix="{{ formset.prefix }}">

  {{ formset.management_form }}

  {% if formset.non_form_errors %}
    <div style="margin-bottom:8px;color:#b91c1c;">
      {% for err in formset.non_form_errors %}
        <div>{{ err }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="kainos-head">
    <div class="kainos-head__text">Kainų eilutės sudaro galutinę kainą.</div>
    <button type="button" class="btn-action btn-secondary" id="kainos-add-row-{{ formset.prefix }}">+ Pridėti eilutę</button>
  </div>

  <div class="poz-price-table-wrapper">
    <table class="poz-price-table kainos-table">
      <thead>
        <tr>
          <th class="col-kaina">Kaina €</th>
          <th class="col-matas">Matas</th>
          <th class="col-qty">Nuo</th>
          <th class="col-qty">Iki</th>
          <th class="col-gal">Galiojimas</th>
          <th class="col-bus">Būsena</th>
          <th class="col-past">Pastabos</th>
          <th class="col-hist">Ist.</th>
          {% if kainos_can_delete %}
            <th class="col-del">Šal.</th>
          {% endif %}
        </tr>
      </thead>

      <tbody id="kainu-formset-body-{{ formset.prefix }}">
        {% for form in formset %}
          {% with st=form.busena_ui.value %}
          <tr class="kaina-row {% if st == 'aktuali' %}kaina-row--aktuali{% else %}kaina-row--neaktuali{% endif %}">
            <td class="cell-kaina">
              {{ form.id }}
              {{ form.kaina }}
              {% if form.kaina.errors %}<div class="errorlist">{{ form.kaina.errors }}</div>{% endif %}
            </td>

            <td class="cell-matas">
              {{ form.matas }}
              {% if form.matas.errors %}<div class="errorlist">{{ form.matas.errors }}</div>{% endif %}
            </td>

            <td class="cell-qty">
              {{ form.kiekis_nuo }}
              {% if form.kiekis_nuo.errors %}<div class="errorlist">{{ form.kiekis_nuo.errors }}</div>{% endif %}
            </td>

            <td class="cell-qty">
              {{ form.kiekis_iki }}
              {% if form.kiekis_iki.errors %}<div class="errorlist">{{ form.kiekis_iki.errors }}</div>{% endif %}
            </td>

            <td class="cell-gal">
              <div class="date-stack">
                {{ form.galioja_nuo }}
                {{ form.galioja_iki }}
              </div>
            </td>

            <td class="cell-bus">
              {{ form.busena_ui }}
              {% if form.busena_ui.errors %}<div class="errorlist">{{ form.busena_ui.errors }}</div>{% endif %}
            </td>

            <td class="cell-past">
              {{ form.pastaba }}
              {% if form.pastaba.errors %}<div class="errorlist">{{ form.pastaba.errors }}</div>{% endif %}
            </td>

            <td class="cell-hist" style="text-align:center;">
              {% if form.instance.pk %}
                <a class="hist-link" href="{% url 'pozicijos:kaina_history' form.instance.pk %}">Ist.</a>
              {% else %}
                —
              {% endif %}
            </td>

            {% if kainos_can_delete %}
              <td class="cell-del" style="text-align:center;">
                {{ form.DELETE }}
              </td>
            {% endif %}
          </tr>
          {% endwith %}
        {% empty %}
          <tr data-empty-row="1">
            <td colspan="{% if kainos_can_delete %}9{% else %}8{% endif %}" style="text-align:center;color:#6b7280;">
              Nėra kainų eilučių.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<style>
  .poz-price-table-wrapper { margin-top:8px; overflow-x:auto; }
  .poz-price-table { width:100%; border-collapse:collapse; font-size:0.88rem; table-layout:fixed; min-width:1040px; }
  .poz-price-table th, .poz-price-table td { border:1px solid #e1e1e1; padding:4px 6px; text-align:left; white-space:nowrap; vertical-align:top; }
  .poz-price-table th { background:#eff6ff; font-weight:600; }
  .poz-price-table tbody tr:nth-child(even) td { background:#f9fafb; }
  .poz-price-table tbody tr:hover td { background:#e0ecff; }

  .kaina-row--aktuali td { background:#ecfdf5; }
  .kaina-row--neaktuali td { background:#f9fafb; color:#6b7280; }

  .kainos-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
  .kainos-head__text{ font-size:0.9rem; color:#666; }

  .date-stack{ display:flex; flex-direction:column; gap:4px; }

  /* FIX: native date input'ai turi didesnį minimalų plotį ir gali „užlipti“ ant Pastabų.
     Leidžiam jiems susitraukti ir šitam stulpeliui nuimam nowrap. */
  .cell-gal, .cell-past { white-space: normal; }
  .date-stack input[type="date"]{ min-width:0; max-width:100%; }

  .poz-price-table input,
  .poz-price-table select,
  .poz-price-table textarea{ width:100%; box-sizing:border-box; }

  .poz-price-table td textarea{ min-height:34px; resize:none; overflow:hidden; }

  .hist-link{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 6px;
    border:1px solid #d1d5db;
    border-radius:6px;
    text-decoration:none;
    color:#111827;
    font-size:0.85rem;
    background:#fff;
  }
  .hist-link:hover{ filter:brightness(0.98); }

  .col-kaina{ width:90px; }
  .col-matas{ width:120px; }
  .col-qty{ width:80px; }
  .col-gal{ width:180px; }
  .col-bus{ width:110px; }
  .col-past{ width:240px; }
  .col-hist{ width:60px; }
  .col-del{ width:55px; }
</style>

<template id="kainos-empty-template-{{ formset.prefix }}">
  {% with f=formset.empty_form %}
  <tr class="kaina-row kaina-row--neaktuali">
    <td class="cell-kaina">{{ f.id }}{{ f.kaina }}</td>
    <td class="cell-matas">{{ f.matas }}</td>
    <td class="cell-qty">{{ f.kiekis_nuo }}</td>
    <td class="cell-qty">{{ f.kiekis_iki }}</td>
    <td class="cell-gal"><div class="date-stack">{{ f.galioja_nuo }}{{ f.galioja_iki }}</div></td>
    <td class="cell-bus">{{ f.busena_ui }}</td>
    <td class="cell-past">{{ f.pastaba }}</td>
    <td class="cell-hist" style="text-align:center;">—</td>
    {% if kainos_can_delete %}
      <td class="cell-del" style="text-align:center;">{{ f.DELETE }}</td>
    {% endif %}
  </tr>
  {% endwith %}
</template>
