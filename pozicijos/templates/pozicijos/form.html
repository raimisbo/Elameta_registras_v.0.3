{# pozicijos/templates/pozicijos/form.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if pozicija %}Redaguoti poziciją {{ pozicija.poz_kodas }}{% else %}Nauja pozicija{% endif %}
{% endblock %}

{% block page_css %}
    {% include "pozicijos/components/form_page_css.html" %}
{% endblock %}

{% block content %}
<div class="poz-form-page">
  <div class="poz-form-container">

      {# Header iškeltas į komponentą #}
      {% include "pozicijos/components/form_header.html" %}

    <form method="post" enctype="multipart/form-data">

      {# Klaidos suvestinė iškelta į komponentą #}
        {% include "pozicijos/components/form_error_summary.html" %}

      {% csrf_token %}


      {% if form.non_field_errors %}
        <div class="poz-card" style="border-color:#fecaca;background:#fff1f2;">
          {{ form.non_field_errors }}
        </div>
      {% endif %}


      <div class="poz-grid">

        {# Pagrindiniai – jau pilnas sekcijos blokas snippete #}
        {% include "pozicijos/components/form_section_pagrindiniai.html" %}

        {# Detalė – jau pilnas sekcijos blokas snippete #}
        {% include "pozicijos/components/form_section_detale.html" %}

        <section class="poz-card poz-card--full">
          <h2 class="poz-card-title">Paslauga</h2>

          {{ form.spalva.as_hidden }}

          <div class="inline-checkboxes">
            <label>{{ form.paslauga_ktl }} <span>{{ form.paslauga_ktl.label }}</span></label>
            <label>{{ form.paslauga_miltai }} <span>{{ form.paslauga_miltai.label }}</span></label>
            <label id="paruosimas-lock-wrap">{{ form.paslauga_paruosimas }}
              <span>{{ form.paslauga_paruosimas.label }}</span></label>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.paruosimas.label }}</div>
            <div class="field-control">
              {{ form.paruosimas }}
              {% if form.paruosimas.errors %}
              <div class="field-errors">{{ form.paruosimas.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.padengimas.label }}</div>
            <div class="field-control">
              {{ form.padengimas }}
              {% if form.padengimas.errors %}
              <div class="field-errors">{{ form.padengimas.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.padengimo_standartas.label }}</div>
            <div class="field-control">
              {{ form.padengimo_standartas }}
              {% if form.padengimo_standartas.errors %}
              <div class="field-errors">{{ form.padengimo_standartas.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.partiju_dydziai.label }}</div>
            <div class="field-control">
              {{ form.partiju_dydziai }}
              {% if form.partiju_dydziai.errors %}
              <div class="field-errors">{{ form.partiju_dydziai.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">Metiniai kiekiai</div>
            <div class="field-control" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div>{{ form.metinis_kiekis_nuo }}</div>
              <div>–</div>
              <div>{{ form.metinis_kiekis_iki }}</div>
            </div>
          </div>
          {% if form.metinis_kiekis_nuo.errors or form.metinis_kiekis_iki.errors %}
          <div class="field-errors">
            {{ form.metinis_kiekis_nuo.errors|striptags }} {{ form.metinis_kiekis_iki.errors|striptags }}
          </div>
          {% endif %}

          <div class="field-row">
            <div class="field-label">Projekto gyvavimo laikotarpis</div>
            <div class="field-control" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <div>{{ form.projekto_gyvavimo_nuo }}</div>
              <div>–</div>
              <div>{{ form.projekto_gyvavimo_iki }}</div>
            </div>
          </div>
          {% if form.projekto_gyvavimo_nuo.errors or form.projekto_gyvavimo_iki.errors %}
          <div class="field-errors">
            {{ form.projekto_gyvavimo_nuo.errors|striptags }} {{ form.projekto_gyvavimo_iki.errors|striptags }}
          </div>
          {% endif %}

          <div id="paslauga-subgrid" class="paslauga-subgrid one-col">

            <div id="ktl-subblock" class="subblock" style="display:none;">
              <div style="font-weight:700; margin:2px 0 8px;">KTL</div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_kabinimo_budas.label }}</div>
                <div class="field-control">
                  {{ form.ktl_kabinimo_budas }}
                  {% if form.ktl_kabinimo_budas.errors %}
                  <div class="field-errors">{{ form.ktl_kabinimo_budas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_kabinimas_reme_txt.label }}</div>
                <div class="field-control">
                  {{ form.ktl_kabinimas_reme_txt }}
                  {% if form.ktl_kabinimas_reme_txt.errors %}
                  <div class="field-errors">{{ form.ktl_kabinimas_reme_txt.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_detaliu_kiekis_reme.label }}</div>
                <div class="field-control">
                  {{ form.ktl_detaliu_kiekis_reme }}
                  {% if form.ktl_detaliu_kiekis_reme.errors %}
                  <div class="field-errors">{{ form.ktl_detaliu_kiekis_reme.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_faktinis_kiekis_reme.label }}</div>
                <div class="field-control">
                  {{ form.ktl_faktinis_kiekis_reme }}
                  {% if form.ktl_faktinis_kiekis_reme.errors %}
                  <div class="field-errors">{{ form.ktl_faktinis_kiekis_reme.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">Detalių išdėstymas rėme</div>
                <div class="field-control">
                  <!-- 1 eilė: I / A / G -->
                  <div style="display:grid; grid-template-columns:repeat(3, minmax(90px, 1fr)); gap:10px;">
                    <div>
                      <div class="field-help" style="margin-bottom:4px;">I (ilgis)</div>
                      {{ form.ktl_ilgis_mm }}
                      {% if form.ktl_ilgis_mm.errors %}
                      <div class="field-errors">{{ form.ktl_ilgis_mm.errors|striptags }}</div>
                      {% endif %}
                    </div>
                    <div>
                      <div class="field-help" style="margin-bottom:4px;">A (aukštis)</div>
                      {{ form.ktl_aukstis_mm }}
                      {% if form.ktl_aukstis_mm.errors %}
                      <div class="field-errors">{{ form.ktl_aukstis_mm.errors|striptags }}</div>
                      {% endif %}
                    </div>
                    <div>
                      <div class="field-help" style="margin-bottom:4px;">G (gylis)</div>
                      {{ form.ktl_gylis_mm }}
                      {% if form.ktl_gylis_mm.errors %}
                      <div class="field-errors">{{ form.ktl_gylis_mm.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- 2 eilė: sandauga -->
                  <div style="display:grid; grid-template-columns:minmax(120px, 180px); gap:10px; margin-top:8px;">
                    <div>
                      <div class="field-help" style="margin-bottom:4px;">I×A×G</div>
                      <input type="text" id="ktl-sandauga-preview" readonly
                             value="{% if form.instance.ktl_matmenu_sandauga %}{{ form.instance.ktl_matmenu_sandauga|floatformat:0 }}{% endif %}"
                             style="background:#f9fafb; color:#6b7280;">
                    </div>
                  </div>
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_kabinimas_aprasymas.label }}</div>
                <div class="field-control">
                  {{ form.ktl_kabinimas_aprasymas }}
                  {% if form.ktl_kabinimas_aprasymas.errors %}
                  <div class="field-errors">{{ form.ktl_kabinimas_aprasymas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_dangos_storis_um.label }}</div>
                <div class="field-control">
                  {{ form.ktl_dangos_storis_um }}
                  {% if form.ktl_dangos_storis_um.errors %}
                  <div class="field-errors">{{ form.ktl_dangos_storis_um.errors|striptags }}</div>
                  {% endif %}
                  <div class="field-help">Galimi formatai: 12.5, 12-13, 3<>6, 33 +/- 5, >=12</div>
                </div>
              </div>

              <div style="margin:10px 0 6px; font-weight:700;">Maskavimas (KTL)</div>
              {{ maskavimo_ktl_formset.management_form }}

              <div class="field-row" style="grid-template-columns:160px 1fr;">
                <div class="field-label"></div>
                <div class="field-control">
                  <button type="button" class="btn btn-secondary maskavimas-add" data-mask-prefix="maskavimas_ktl">
                    Pridėti
                  </button>
                </div>
              </div>

              <div id="maskavimas_ktl-items" class="subblock" style="display:none;">
                {% for f in maskavimo_ktl_formset %}
                <div class="maskavimas-item" data-mask-prefix="maskavimas_ktl"
                     style="border-bottom:1px solid #f3f4f6; padding:8px 0;">
                  {{ f.id }}
                  <div style="display:none;">{{ f.DELETE }}</div>

                  <div class="field-row">
                    <div class="field-label">{{ f.maskuote.label }}</div>
                    <div class="field-control">
                      {{ f.maskuote }}
                      {% if f.maskuote.errors %}
                      <div class="field-errors">{{ f.maskuote.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ f.vietu_kiekis.label }}</div>
                    <div class="field-control">
                      {{ f.vietu_kiekis }}
                      {% if f.vietu_kiekis.errors %}
                      <div class="field-errors">{{ f.vietu_kiekis.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ f.aprasymas.label }}</div>
                    <div class="field-control">
                      {{ f.aprasymas }}
                      {% if f.aprasymas.errors %}
                      <div class="field-errors">{{ f.aprasymas.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div style="display:flex; justify-content:flex-end;">
                    <button type="button" class="btn btn-secondary maskavimas-remove" data-mask-prefix="maskavimas_ktl">
                      Pašalinti
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>

              <template id="maskavimas_ktl-empty-form">
                <div class="maskavimas-item" data-mask-prefix="maskavimas_ktl"
                     style="border-bottom:1px solid #f3f4f6; padding:8px 0;">
                  {{ maskavimo_ktl_formset.empty_form.id }}
                  <div style="display:none;">{{ maskavimo_ktl_formset.empty_form.DELETE }}</div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_ktl_formset.empty_form.maskuote.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_ktl_formset.empty_form.maskuote }}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_ktl_formset.empty_form.vietu_kiekis.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_ktl_formset.empty_form.vietu_kiekis }}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_ktl_formset.empty_form.aprasymas.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_ktl_formset.empty_form.aprasymas }}
                    </div>
                  </div>

                  <div style="display:flex; justify-content:flex-end;">
                    <button type="button" class="btn btn-secondary maskavimas-remove" data-mask-prefix="maskavimas_ktl">
                      Pašalinti
                    </button>
                  </div>
                </div>
              </template>

              <div class="field-row">
                <div class="field-label">{{ form.ktl_pastabos.label }}</div>
                <div class="field-control">
                  {{ form.ktl_pastabos }}
                  {% if form.ktl_pastabos.errors %}
                  <div class="field-errors">{{ form.ktl_pastabos.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div id="miltai-subblock" class="subblock" style="display:none;">
              <div style="font-weight:700; margin:2px 0 8px;">Miltai</div>

              <div class="field-row">
                <div class="field-label">{{ form.miltu_kodas.label }}</div>
                <div class="field-control">
                  {{ form.miltu_kodas }}
                  {% if form.miltu_kodas.errors %}
                  <div class="field-errors">{{ form.miltu_kodas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltu_spalva.label }}</div>
                <div class="field-control">
                  {{ form.miltu_spalva }}
                  {% if form.miltu_spalva.errors %}
                  <div class="field-errors">{{ form.miltu_spalva.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltu_tiekejas.label }}</div>
                <div class="field-control">
                  {{ form.miltu_tiekejas }}
                  {% if form.miltu_tiekejas.errors %}
                  <div class="field-errors">{{ form.miltu_tiekejas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltu_blizgumas.label }}</div>
                <div class="field-control">
                  {{ form.miltu_blizgumas }}
                  {% if form.miltu_blizgumas.errors %}
                  <div class="field-errors">{{ form.miltu_blizgumas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltu_kaina.label }}</div>
                <div class="field-control">
                  {{ form.miltu_kaina }}
                  {% if form.miltu_kaina.errors %}
                  <div class="field-errors">{{ form.miltu_kaina.errors|striptags }}</div>
                  {% endif %}
                  <div class="field-help">€ (4 skaičiai po kablelio).</div>
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_dangos_storis_um.label }}</div>
                <div class="field-control">
                  {{ form.miltai_dangos_storis_um }}
                  {% if form.miltai_dangos_storis_um.errors %}
                  <div class="field-errors">{{ form.miltai_dangos_storis_um.errors|striptags }}</div>
                  {% endif %}
                  <div class="field-help">Galimi formatai: 12.5, 12-13, 3<>6, 33 +/- 5, >=12</div>
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_kiekis_per_valanda.label }}</div>
                <div class="field-control">
                  {{ form.miltai_kiekis_per_valanda }}
                  {% if form.miltai_kiekis_per_valanda.errors %}
                  <div class="field-errors">{{ form.miltai_kiekis_per_valanda.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_faktinis_per_valanda.label }}</div>
                <div class="field-control">
                  {{ form.miltai_faktinis_per_valanda }}
                  {% if form.miltai_faktinis_per_valanda.errors %}
                  <div class="field-errors">{{ form.miltai_faktinis_per_valanda.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_detaliu_kiekis_reme.label }}</div>
                <div class="field-control">
                  {{ form.miltai_detaliu_kiekis_reme }}
                  {% if form.miltai_detaliu_kiekis_reme.errors %}
                  <div class="field-errors">{{ form.miltai_detaliu_kiekis_reme.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_faktinis_kiekis_reme.label }}</div>
                <div class="field-control">
                  {{ form.miltai_faktinis_kiekis_reme }}
                  {% if form.miltai_faktinis_kiekis_reme.errors %}
                  <div class="field-errors">{{ form.miltai_faktinis_kiekis_reme.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_kabinimas_aprasymas.label }}</div>
                <div class="field-control">
                  {{ form.miltai_kabinimas_aprasymas }}
                  {% if form.miltai_kabinimas_aprasymas.errors %}
                  <div class="field-errors">{{ form.miltai_kabinimas_aprasymas.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>

              <div style="margin:10px 0 6px; font-weight:700;">Maskavimas (Miltai)</div>
              {{ maskavimo_miltai_formset.management_form }}

              <div class="field-row" style="grid-template-columns:160px 1fr;">
                <div class="field-label"></div>
                <div class="field-control">
                  <button type="button" class="btn btn-secondary maskavimas-add" data-mask-prefix="maskavimas_miltai">
                    Pridėti
                  </button>
                </div>
              </div>

              <div id="maskavimas_miltai-items" class="subblock" style="display:none;">
                {% for f in maskavimo_miltai_formset %}
                <div class="maskavimas-item" data-mask-prefix="maskavimas_miltai"
                     style="border-bottom:1px solid #f3f4f6; padding:8px 0;">
                  {{ f.id }}
                  <div style="display:none;">{{ f.DELETE }}</div>

                  <div class="field-row">
                    <div class="field-label">{{ f.maskuote.label }}</div>
                    <div class="field-control">
                      {{ f.maskuote }}
                      {% if f.maskuote.errors %}
                      <div class="field-errors">{{ f.maskuote.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ f.vietu_kiekis.label }}</div>
                    <div class="field-control">
                      {{ f.vietu_kiekis }}
                      {% if f.vietu_kiekis.errors %}
                      <div class="field-errors">{{ f.vietu_kiekis.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ f.aprasymas.label }}</div>
                    <div class="field-control">
                      {{ f.aprasymas }}
                      {% if f.aprasymas.errors %}
                      <div class="field-errors">{{ f.aprasymas.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div style="display:flex; justify-content:flex-end;">
                    <button type="button" class="btn btn-secondary maskavimas-remove"
                            data-mask-prefix="maskavimas_miltai">Pašalinti
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>

              <template id="maskavimas_miltai-empty-form">
                <div class="maskavimas-item" data-mask-prefix="maskavimas_miltai"
                     style="border-bottom:1px solid #f3f4f6; padding:8px 0;">
                  {{ maskavimo_miltai_formset.empty_form.id }}
                  <div style="display:none;">{{ maskavimo_miltai_formset.empty_form.DELETE }}</div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_miltai_formset.empty_form.maskuote.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_miltai_formset.empty_form.maskuote }}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_miltai_formset.empty_form.vietu_kiekis.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_miltai_formset.empty_form.vietu_kiekis }}
                    </div>
                  </div>

                  <div class="field-row">
                    <div class="field-label">{{ maskavimo_miltai_formset.empty_form.aprasymas.label }}</div>
                    <div class="field-control">
                      {{ maskavimo_miltai_formset.empty_form.aprasymas }}
                    </div>
                  </div>

                  <div style="display:flex; justify-content:flex-end;">
                    <button type="button" class="btn btn-secondary maskavimas-remove"
                            data-mask-prefix="maskavimas_miltai">Pašalinti
                    </button>
                  </div>
                </div>
              </template>

              <div class="field-row">
                <div class="field-label">{{ form.miltai_pastabos.label }}</div>
                <div class="field-control">
                  {{ form.miltai_pastabos }}
                  {% if form.miltai_pastabos.errors %}
                  <div class="field-errors">{{ form.miltai_pastabos.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="field-row" style="margin-top:10px;">
            <div class="field-label">{{ form.paslaugu_pastabos.label }}</div>
            <div class="field-control">
              {{ form.paslaugu_pastabos }}
              {% if form.paslaugu_pastabos.errors %}
              <div class="field-errors">{{ form.paslaugu_pastabos.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>
        </section>

        {% include "pozicijos/components/form_section_terminai.html" %}

        {% include "pozicijos/components/form_section_testai_kokybe.html" %}

        {% include "pozicijos/components/form_section_pakavimas.html" %}

        {% include "pozicijos/components/form_section_papildomos_paslaugos.html" %}

        {% include "pozicijos/components/form_section_kainos.html" %}

        {% include "pozicijos/components/form_section_pastabos.html" %}

      </div>

      {% include "pozicijos/components/form_actions.html" %}

    </form>

  </div>
</div>
{% endblock %}

{% block page_js %}
{% include "pozicijos/components/form_page_js.html" %}
{% endblock %}