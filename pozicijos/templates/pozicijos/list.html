{% extends "base.html" %}
{% load attr %}
{% load dict_get %}
{% load json_utils %}

{% block title %}Pozicijų sąrašas{% endblock %}

{% block page_css %}
<style>
  /* Paslepiam seną headerį (šitam puslapiui nereikia) */
  header, .navbar, .topbar { display: none !important; }

  .top-wrap {
    display:flex;
    align-items:flex-start;
    gap:1rem;
    margin-bottom:.75rem;
  }

  .logo-block {
    display:flex;
    align-items:center;
    min-width:140px;
  }
  .logo-block img {
    max-height:42px;
    width:auto;
    display:block;
  }

  .title-block{ flex:1; text-align:center; }
  .title-block h1{ margin:0; font-size:1.4rem; font-weight:600; }

  .controls-block { display:flex; flex-direction:column; gap:.35rem; margin-bottom:.5rem; }
  .controls-bar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .controls-bar input[type="search"]{padding:.25rem .5rem; min-width:220px;}
  .controls-bar button,
  .controls-bar a.btn{padding:.25rem .6rem; cursor:pointer; text-decoration:none;}
  .chips{display:flex; gap:.35rem; flex-wrap:wrap;}
  .chip{background:#e2e8f0; padding:2px 6px; border-radius:4px; display:inline-flex; gap:4px; align-items:center; font-size:.8rem;}
  .chip button{border:0; background:transparent; cursor:pointer;}

  .graph-box{
    display:flex;
    gap:.75rem;
    align-items:flex-start;
    min-width:240px;
  }
  .donut-box{position:relative; width:220px; height:220px;}
  .donut-box canvas{width:220px!important; height:220px!important;}
  .donut-center{position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; font-weight:700; font-size:22px; pointer-events:none; text-align:center;}
  .donut-center span{font-size:12px; opacity:.7;}
  .donut-legend{list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow:auto; min-width:140px;}
  .donut-legend li{display:flex; align-items:center; gap:8px; font-size:14px;}
  .donut-legend .dot{width:10px; height:10px; border-radius:50%;}

  .table-wrap{
    overflow:auto;
    max-height:calc(100vh - 180px);
    border:1px solid #ddd;
    background:#fff;
  }

  #pozicijos-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
  }

  #pozicijos-table thead tr.headers th{background:#f4f4f4;}
  #pozicijos-table thead tr.filters th{background:#fafafa;}

  #pozicijos-table thead th{
    position:sticky;
    top:0;
    padding:.4rem .5rem;
    border-bottom:1px solid #ddd;
    white-space:nowrap;
    z-index:5;
  }

  #pozicijos-table thead tr.filters th{
    top:34px;
    z-index:6;
  }

  #pozicijos-table tbody td{
    padding:.35rem .5rem;
    border-bottom:1px solid #eee;
    background:#fff;
  }
  #pozicijos-table tbody tr:nth-child(even) td{background:#f8f8f8;}

  .th-filter{width:100%; box-sizing:border-box;}
  .th-filter.is-invalid{
    border:1px solid #dc2626 !important;
    background:#fff7f7;
    box-shadow:0 0 0 1px rgba(220,38,38,.15);
  }

  /* Sticky pirmai kolonelei + papildomos klasės (naudojamos JS) */
  #pozicijos-table thead tr.headers th.sticky-col-header{
    position:sticky !important;
    top:0;
    left:0;
    z-index:200;
    background:#f4f4f4 !important;
  }
  #pozicijos-table thead tr.filters th.sticky-col-filter{
    position:sticky !important;
    top:34px;
    left:0;
    z-index:190;
    background:#fafafa !important;
  }
  #pozicijos-table tbody td.sticky-col-cell{
    position:sticky;
    left:0;
    z-index:180;
    background:inherit;
  }

  /* Rikiavimo rodyklės headeriuose */
  #pozicijos-table thead tr.headers th[data-sort="asc"]::after{
    content:" ▲";
    font-size:.75em;
    opacity:.65;
  }
  #pozicijos-table thead tr.headers th[data-sort="desc"]::after{
    content:" ▼";
    font-size:.75em;
    opacity:.65;
  }

  .drawer-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:.2s;}
  .drawer-backdrop.open{opacity:1; pointer-events:auto;}
  .drawer{position:fixed; top:0; right:-320px; width:320px; height:100vh; background:#fff; box-shadow:-2px 0 8px rgba(0,0,0,.25); transition:.2s; display:flex; flex-direction:column; z-index:100;}
  .drawer.open{right:0;}
  .drawer-header{display:flex; justify-content:space-between; align-items:center; padding:.75rem .75rem; border-bottom:1px solid #eee;}
  .drawer-body{padding:.75rem .75rem; overflow:auto; display:flex; flex-direction:column; gap:.5rem;}

  .cols-search{width:100%; padding:.25rem .5rem; margin-bottom:.25rem;}
  #cols-list { display:flex; flex-direction:column; gap:.35rem; }
  #cols-list label { display:flex; gap:.4rem; align-items:center; }

  /* Papildomai – kad vertikalus scroll būtų per visą puslapį, o ne tik per table-wrap */
  .table-wrap{ overflow: visible !important; }
  main, .content{ overflow: visible !important; }
</style>
{% endblock %}

{% block content %}

<div class="top-wrap">
  <div class="logo-block">
    <img src="{{ MEDIA_URL }}logo.png" alt="Logo">
  </div>
  <div class="title-block">
    <h1>Detalių registras</h1>
  </div>
  <div class="graph-box">
    <div class="donut-box">
      <canvas id="statsDonut" width="220" height="220"></canvas>
      <div class="donut-center" id="donutCenter">0<br><span>įrašų</span></div>
    </div>
    <ul class="donut-legend" id="donutLegend"></ul>
  </div>
</div>

<div class="controls-block">
  <div class="controls-bar">
    <a href="{% url 'pozicijos:create' %}" class="btn btn-primary">+ Nauja pozicija</a>
    <input id="q" name="q" type="search" placeholder="Globali paieška..." value="{{ q|default:'' }}">
    <button id="btn-cols" type="button">Stulpeliai</button>
    <button id="btn-clear" type="button">Išvalyti</button>
    <label>Rodyti:
      <select id="page_size" name="page_size">
        <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
        <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
      </select>
    </label>
  </div>
  <div id="chips" class="chips"></div>
</div>

<div class="table-wrap" id="pozicijos-wrap">
  <table id="pozicijos-table">
    <colgroup id="pozicijos-colgroup">
      {% for c in columns_schema %}
        <col data-key="{{ c.key }}" style="width:{{ c.width }}px" {% if c.key not in visible_cols %}hidden{% endif %}>
      {% endfor %}
    </colgroup>
    <thead>
      <tr class="headers">
        {% for c in columns_schema %}
          <th data-key="{{ c.key }}" {% if c.key not in visible_cols %}hidden{% endif %}>{{ c.label }}</th>
        {% endfor %}
      </tr>
      <tr class="filters">
        {% for c in columns_schema %}
          <th data-key="{{ c.key }}" {% if c.key not in visible_cols %}hidden{% endif %}>
            {% if c.filter == "text" %}
            <input class="th-filter" data-key="{{ c.key }}" data-filter-type="text" type="text"
                   placeholder="filtruok..." value="{{ f|dict_get:c.key|default:'' }}">
            {% elif c.filter == "range" %}
            <input class="th-filter" data-key="{{ c.key }}" data-filter-type="range" type="text"
                   placeholder="min..max, >=10, =15" value="{{ f|dict_get:c.key|default:'' }}">
            {% elif c.filter == "date" %}
            <input class="th-filter" data-key="{{ c.key }}" data-filter-type="date" type="date"
                   value="{{ f|dict_get:c.key|default:'' }}">
            {% else %}
              &nbsp;
            {% endif %}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody id="tbody">
      {% include "pozicijos/_tbody.html" %}
    </tbody>
  </table>
</div>

<div id="drawer-backdrop" class="drawer-backdrop"></div>
<aside id="drawer" class="drawer">
  <div class="drawer-header">
    <strong>Stulpeliai</strong>
    <button id="drawer-close" type="button">✖</button>
  </div>
  <div class="drawer-body">
    <input id="cols-search" class="cols-search" type="search" placeholder="Ieškoti stulpelių...">
    <div style="display:flex; gap:.5rem; margin:.25rem 0 .5rem;">
      <button id="cols-all-off" type="button">Išjungti visus</button>
      <button id="cols-all-on" type="button">Pažymėti visus</button>
      <button id="cols-default" type="button">Numatytieji</button>
      <button id="cols-reset" type="button">↺ Atstatyti tvarką</button>
    </div>
    <div id="cols-list">
      {% for c in columns_schema %}
        <label data-key="{{ c.key }}">
          <input type="checkbox" class="col-toggle" value="{{ c.key }}" {% if c.key in visible_cols %}checked{% endif %}>
          {{ c.label }}
        </label>
      {% endfor %}
    </div>
  </div>
</aside>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="application/json" id="columns-schema">
  {{ columns_schema|tojson }}
</script>

<script>
(function(){
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  const SCHEMA = JSON.parse(document.getElementById("columns-schema").textContent);

  const DEFAULT_KEYS = ["klientas","projektas","poz_kodas","poz_pavad","kaina_eur","pastabos"];
  const KEY_COLS = "pozicijos:visibleCols:v2";
  const DND_KEY  = "dnd-order:pozicijos";

  const TYPE_BY_KEY = {};
  const FILTER_BY_KEY = {};
  SCHEMA.forEach(c => {
    TYPE_BY_KEY[c.key] = c.type || "text";
    FILTER_BY_KEY[c.key] = c.filter || "text";
  });

  let sortKey = null;
  let sortDir = "asc";

  (function readSortFromUrl(){
    try {
      const params = new URLSearchParams(window.location.search);
      const s = params.get("sort");
      const d = params.get("dir");
      if (s) sortKey = s;
      if (d === "asc" || d === "desc") sortDir = d;
    } catch(e) {}
  })();

  const table    = $("#pozicijos-table");
  const wrap     = $("#pozicijos-wrap");
  const q        = $("#q");
  const pageSize = $("#page_size");
  const chips    = $("#chips");
  const drawer   = $("#drawer");
  const backdrop = $("#drawer-backdrop");
  const btnClear = $("#btn-clear");

  const PALETTE = ["#0ea5e9","#22c55e","#f97316","#e11d48","#6366f1","#14b8a6","#facc15","#8b5cf6","#6b7280","#f43f5e","#a855f7","#10b981"];

  function getDefaultColsFromSchema() {
    return SCHEMA.filter(c => DEFAULT_KEYS.includes(c.key)).map(c => c.key);
  }

  function getVisibleCols(){
    const s = localStorage.getItem(KEY_COLS);
    if (!s) return getDefaultColsFromSchema();
    try { return JSON.parse(s); } catch(e) { return getDefaultColsFromSchema(); }
  }

  function setVisibleCols(keys){
    localStorage.setItem(KEY_COLS, JSON.stringify(keys));

    $$("#pozicijos-colgroup col").forEach(col => {
      const k = col.dataset.key; if (!k) return;
      if (keys.includes(k)) col.removeAttribute("hidden");
      else col.setAttribute("hidden","");
    });

    $$("#pozicijos-table thead th").forEach(th => {
      const k = th.dataset.key; if (!k) return;
      if (keys.includes(k)) th.removeAttribute("hidden");
      else th.setAttribute("hidden","");
    });

    $$(".col-toggle").forEach(ch => ch.checked = keys.includes(ch.value));

    fetchTbody();
    document.dispatchEvent(new CustomEvent("visibility:columns-changed"));
  }

  // ---- filtrų normalizacija ----
  function normalizeDate(v){
    const s = (v || "").trim();
    if (!s) return "";
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    return s;
  }

  function normalizeRange(v){
    let s = (v || "").trim();
    if (!s) return "";

    // unifikuojam brūkšnius ir tarpus
    s = s.replace(/[–—]/g, "-").replace(/\s+/g, "");

    // leidžiami:
    // 10..20
    // 10-20
    // >=10 <=20 >10 <20 =10
    // 10 (interpretuojam kaip =10)
    const rangePat = /^-?\d+(?:[.,]\d+)?(\.\.|-)-?\d+(?:[.,]\d+)?$/;
    const cmpPat   = /^(>=|<=|>|<|=)-?\d+(?:[.,]\d+)?$/;
    const numPat   = /^-?\d+(?:[.,]\d+)?$/;

    if (rangePat.test(s)) return s.replace(",", ".");
    if (cmpPat.test(s)) return s.replace(",", ".");
    if (numPat.test(s)) return "=" + s.replace(",", ".");

    return null; // netinkamas
  }

  function collectFiltersAndMarkInvalid(){
    const result = {};
    $$(".th-filter").forEach(inp => {
      inp.classList.remove("is-invalid");
      const key = inp.dataset.key;
      const raw = (inp.value || "").trim();
      if (!raw) return;

      const filterType = inp.dataset.filterType || FILTER_BY_KEY[key] || "text";

      if (filterType === "range") {
        const n = normalizeRange(raw);
        if (n === null) {
          inp.classList.add("is-invalid");
          return;
        }
        if (n) result[key] = n;
        return;
      }

      if (filterType === "date") {
        const n = normalizeDate(raw);
        if (n === null) {
          inp.classList.add("is-invalid");
          return;
        }
        if (n) result[key] = n;
        return;
      }

      result[key] = raw;
    });
    return result;
  }

  // --- stalčius ---
  $("#btn-cols")?.addEventListener("click", () => {
    drawer.classList.add("open");
    backdrop.classList.add("open");
  });
  $("#drawer-close")?.addEventListener("click", () => {
    drawer.classList.remove("open");
    backdrop.classList.remove("open");
  });
  backdrop?.addEventListener("click", () => {
    drawer.classList.remove("open");
    backdrop.classList.remove("open");
  });
  document.addEventListener("keydown", e => {
    if (e.key === "Escape"){
      drawer.classList.remove("open");
      backdrop.classList.remove("open");
    }
  });

  $("#cols-all-off")?.addEventListener("click", () => setVisibleCols([]));
  $("#cols-all-on")?.addEventListener("click", () => setVisibleCols(SCHEMA.map(c=>c.key)));
  $("#cols-default")?.addEventListener("click", () => setVisibleCols(getDefaultColsFromSchema()));
  $("#cols-reset")?.addEventListener("click", () => {
    localStorage.removeItem(DND_KEY);
    localStorage.removeItem(KEY_COLS);
    location.reload();
  });

  $("#cols-search")?.addEventListener("input", e => {
    const v = e.target.value.toLowerCase();
    $$("#cols-list label").forEach(l => {
      l.style.display = l.textContent.toLowerCase().includes(v) ? "" : "none";
    });
  });

  $$(".col-toggle").forEach(ch => {
    ch.addEventListener("change", () => {
      const cur = new Set(getVisibleCols());
      if (ch.checked) cur.add(ch.value); else cur.delete(ch.value);
      setVisibleCols([...cur]);
    });
  });

  function buildParams(){
    const p = new URLSearchParams();

    const cols = getVisibleCols();
    if (cols.length) p.set("cols", cols.join(","));

    const g = q ? q.value.trim() : "";
    if (g) p.set("q", g);

    const filters = collectFiltersAndMarkInvalid();
    Object.entries(filters).forEach(([k,v]) => p.set(`f[${k}]`, v));

    if (pageSize) p.set("page_size", pageSize.value);

    if (sortKey) {
      p.set("sort", sortKey);
      p.set("dir", sortDir);
    }

    return p;
  }

  let inflight;
  function fetchTbody(){
    const params = buildParams();
    const url = new URL("{% url 'pozicijos:tbody' %}", location.origin);
    url.search = params.toString();

    const active = document.activeElement;
    const isInput = active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA");
    const selStart = isInput ? active.selectionStart : null;
    const selEnd   = isInput ? active.selectionEnd   : null;

    if (inflight) inflight.abort();
    inflight = new AbortController();
    fetch(url, {signal: inflight.signal})
      .then(r => r.text())
      .then(html => {
        $("#tbody").innerHTML = html;
        renderChips();
        history.replaceState(null, "", "?" + params.toString());
        fetchStatsAndRender();
        document.dispatchEvent(new Event("tbody:reloaded"));

        if (isInput && active) {
          active.focus();
          if (selStart !== null && selEnd !== null) active.setSelectionRange(selStart, selEnd);
        }
      })
      .catch(() => {});
  }

  const debounce = (fn, ms=300) => {
    let t;
    return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
  };
  const debouncedFetch = debounce(fetchTbody, 300);

  if (q) q.addEventListener("input", debouncedFetch);

  $$(".th-filter").forEach(inp => {
    inp.addEventListener("input", debouncedFetch);
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        fetchTbody();
      }
    });
  });

  if (pageSize) pageSize.addEventListener("change", fetchTbody);

  if (btnClear) btnClear.addEventListener("click", () => {
    if (q) q.value = "";
    $$(".th-filter").forEach(i => {
      i.value = "";
      i.classList.remove("is-invalid");
    });
    localStorage.removeItem(KEY_COLS);
    localStorage.removeItem(DND_KEY);
    sortKey = null;
    sortDir = "asc";
    fetchTbody();
  });

  function renderChips(){
    if (!chips) return;
    chips.innerHTML = "";

    if (q && q.value.trim()){
      chips.append(chipEl("q: " + q.value, () => { q.value=""; fetchTbody(); }));
    }

    const filters = collectFiltersAndMarkInvalid();
    Object.entries(filters).forEach(([key,val]) => {
      chips.append(chipEl(`${key}: ${val}`, () => {
        const inp = document.querySelector(`.th-filter[data-key="${key}"]`);
        if (inp) {
          inp.value = "";
          inp.classList.remove("is-invalid");
        }
        fetchTbody();
      }));
    });
  }

  function chipEl(text, onX){
    const el = document.createElement("span");
    el.className = "chip";
    el.innerHTML = text + ' <button type="button">×</button>';
    el.querySelector("button").addEventListener("click", onX);
    return el;
  }

  let donutChart = null;
  function ensureDonut(){
    if (donutChart) return donutChart;
    const ctx = document.getElementById("statsDonut");
    if (!ctx || typeof Chart === "undefined") return null;
    donutChart = new Chart(ctx, {
      type: "doughnut",
      data: { labels: ["—"], datasets: [{ data: [1], backgroundColor: ["#0ea5e9"] }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, cutout:"60%" }
    });
    return donutChart;
  }

  function renderLegend(labels, values){
    const ul = document.getElementById("donutLegend");
    ul.innerHTML = "";
    labels.forEach((lbl,i)=>{
      const li = document.createElement("li");
      li.innerHTML = `<span class="dot" style="background:${PALETTE[i%PALETTE.length]}"></span> ${lbl} — ${values[i]}`;
      ul.appendChild(li);
    });
  }

  function updateCenter(total){
    document.getElementById("donutCenter").innerHTML = (total||0) + "<br><span>įrašų</span>";
  }

  function fetchStatsAndRender(){
    const params = buildParams();
    const url = new URL("{% url 'pozicijos:stats' %}", location.origin);
    url.search = params.toString();

    fetch(url)
      .then(r => r.json())
      .then(({labels, values, total}) => {
        const ch = ensureDonut();
        if (!ch) return;
        if (!values || !values.length){
          ch.data.labels = ["—"];
          ch.data.datasets[0].data = [1];
          ch.data.datasets[0].backgroundColor = ["#0ea5e9"];
          ch.update();
          renderLegend([], []);
          updateCenter(total || 0);
          return;
        }
        ch.data.labels = labels;
        ch.data.datasets[0].data = values;
        ch.data.datasets[0].backgroundColor = labels.map((_,i)=>PALETTE[i%PALETTE.length]);
        ch.update();
        renderLegend(labels, values);
        updateCenter(total || values.reduce((a,b)=>a+b,0));
      })
      .catch(()=>{
        const ch = ensureDonut();
        if (ch){
          ch.data.labels = ["—"];
          ch.data.datasets[0].data = [1];
          ch.data.datasets[0].backgroundColor = ["#0ea5e9"];
          ch.update();
        }
        renderLegend([], []);
        updateCenter(0);
      });
  }

  function detectAndApplySticky(){
    const tbl = table;
    const container = wrap;
    if (!tbl || !container) return;

    tbl.querySelectorAll(".sticky-col-header,.sticky-col-filter,.sticky-col-cell")
      .forEach(el => {
        el.classList.remove("sticky-col-header","sticky-col-filter","sticky-col-cell");
        el.style.left = "";
        el.style.backgroundColor = "";
      });

    const headerRow = tbl.querySelector("thead tr.headers");
    const filterRow = tbl.querySelector("thead tr.filters");
    if (!headerRow) return;

    const containerRect = container.getBoundingClientRect();
    const headersTop = headerRow.getBoundingClientRect().top + 1;

    let th = document.elementFromPoint(containerRect.left + 1, headersTop);
    while (th && th.tagName !== "TH") th = th.parentElement;

    if (!th || th.hasAttribute("hidden")) {
      const vis = Array.from(headerRow.querySelectorAll("th"))
        .filter(h => !h.hasAttribute("hidden") && h.offsetParent !== null);
      if (!vis.length) return;
      th = vis[0];
    }

    const key = th.dataset.key;
    if (!key) return;

    th.classList.add("sticky-col-header");

    if (filterRow) {
      const fth = filterRow.querySelector(`th[data-key="${key}"]`);
      if (fth) fth.classList.add("sticky-col-filter");
    }

    tbl.querySelectorAll("tbody tr").forEach(tr => {
      const td = tr.querySelector(`td[data-key="${key}"]`);
      if (!td) return;
      const bg = getComputedStyle(td).backgroundColor;
      td.classList.add("sticky-col-cell");
      td.style.backgroundColor = bg;
    });
  }

  function updateSortIndicators(){
    if (!table) return;
    const headers = table.querySelectorAll("thead tr.headers th");
    headers.forEach(th => {
      const key = th.dataset.key;
      if (!key) return;
      if (key === sortKey) th.dataset.sort = sortDir;
      else th.removeAttribute("data-sort");
    });
  }

  const headerRow = table.querySelector("thead tr.headers");
  if (headerRow) {
    headerRow.addEventListener("click", function(e){
      const th = e.target.closest("th");
      if (!th || !headerRow.contains(th)) return;
      const key = th.dataset.key;
      if (!key) return;
      if (TYPE_BY_KEY[key] === "virtual") return;

      if (sortKey === key) sortDir = (sortDir === "asc" ? "desc" : "asc");
      else { sortKey = key; sortDir = "asc"; }

      updateSortIndicators();
      fetchTbody();
    });
  }

  document.addEventListener("visibility:columns-changed", detectAndApplySticky);
  document.addEventListener("tbody:reloaded", () => {
    detectAndApplySticky();
    updateSortIndicators();
  });

  document.addEventListener("DOMContentLoaded", () => {
    setVisibleCols(getVisibleCols());
    renderChips();
    fetchStatsAndRender();
    detectAndApplySticky();
    updateSortIndicators();
  });

  window.applyStickyFirstCol = detectAndApplySticky;
})();
</script>

{% include "snippets/columns_dnd_shared.html" with table_id="pozicijos-table" page_key="pozicijos" %}
{% endblock %}
