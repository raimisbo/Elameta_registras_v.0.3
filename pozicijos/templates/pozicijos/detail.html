{% extends "base.html" %}
{% load static %}

{% block title %}Pozicija {{ pozicija.poz_kodas|default:pozicija.id }}{% endblock %}
{% block body_class %}pozicija-detail-page{% endblock %}

{% block page_css %}
<style>
  .pozicija-detail-page { background:#f3f3f3; }
  .pozicija-detail-page .poz-detail-container { max-width:1200px; margin:0 auto; padding:16px 20px 32px; }

  .pozicija-detail-page .detail-header-bar { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:16px; }
  .pozicija-detail-page .detail-header-main { min-width:0; }
  .pozicija-detail-page .detail-header-title { margin:0 0 4px; font-size:1.35rem; font-weight:600; }
  .pozicija-detail-page .detail-header-sub { margin:0; font-size:0.9rem; color:#666; }

  .pozicija-detail-page .detail-header-actions { display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
  .pozicija-detail-page .btn-action { display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; font-size:0.85rem; border-radius:4px; border:1px solid #ccc; background:#fff; color:#333; text-decoration:none; cursor:pointer; white-space:nowrap; }
  .pozicija-detail-page .btn-action:hover { background:#f0f0f0; }
  .pozicija-detail-page .btn-action.btn-secondary { background:#e7f0ff; border-color:#b6c9f0; }
  .pozicija-detail-page .btn-action.btn-secondary:hover { background:#d7e4ff; }

  .pozicija-detail-page .poz-cards-grid { display:grid; grid-template-columns:minmax(0,1.4fr) minmax(0,1.2fr); gap:16px; align-items:flex-start; }

  .pozicija-detail-page .poz-card { background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:12px 14px 10px; box-shadow:0 1px 3px rgba(15,23,42,0.06); }
  .pozicija-detail-page .poz-card--full { grid-column:1 / -1; }

  .pozicija-detail-page .poz-card--client { grid-column:1; grid-row:1; }
  .pozicija-detail-page .poz-card--detail { grid-column:1; grid-row:2; }
  .pozicija-detail-page .poz-card--brez { grid-column:2; grid-row:1 / span 2; }

  .pozicija-detail-page .poz-card-title { margin:0 0 8px; font-size:0.95rem; font-weight:600; color:#333; }

  .pozicija-detail-page .poz-fields { display:flex; flex-direction:column; gap:4px; }
  .pozicija-detail-page .poz-field-row { display:grid; grid-template-columns:minmax(0,42%) minmax(0,58%); column-gap:8px; align-items:flex-start; font-size:0.9rem; padding:2px 0; }
  .pozicija-detail-page .poz-field-label { color:#777; text-align:left; }
  .pozicija-detail-page .poz-field-value { color:#222; word-wrap:break-word; overflow-wrap:anywhere; }

  .pozicija-detail-page .poz-field-value--alert { color:#b91c1c; font-weight:600; animation:pozBlink 1s ease-in-out infinite alternate; }
  @keyframes pozBlink { 0%{ color:#b91c1c; } 100%{ color:#f97316; } }

  .pozicija-detail-page .poz-empty { margin:4px 0 0; font-size:0.88rem; color:#999; font-style:italic; }
  .pozicija-detail-page .poz-notes-text { font-size:0.9rem; line-height:1.4; white-space:pre-wrap; }

  .pozicija-detail-page .poz-price-table-wrapper { margin-top:8px; overflow-x:auto; }
  .pozicija-detail-page .poz-price-table { width:100%; border-collapse:collapse; font-size:0.88rem; }
  .pozicija-detail-page .poz-price-table th, .pozicija-detail-page .poz-price-table td { border:1px solid #e1e1e1; padding:4px 6px; text-align:left; white-space:nowrap; }
  .pozicija-detail-page .poz-price-table th { background:#eff6ff; font-weight:600; }
  .pozicija-detail-page .poz-price-table tbody tr:nth-child(even) td { background:#f9fafb; }
  .pozicija-detail-page .poz-price-table tbody tr:hover td { background:#e0ecff; }
  .pozicija-detail-page .poz-card-footer { margin-top:8px; display:flex; justify-content:flex-end; }

  .pozicija-detail-page .poz-brez-grid { display:flex; flex-wrap:wrap; gap:10px; }
  .pozicija-detail-page .poz-brez-item { width:130px; border:1px solid #e1e1e1; border-radius:4px; padding:4px; background:#fff; display:flex; flex-direction:column; gap:4px; }
  .pozicija-detail-page .poz-brez-thumb-wrap { width:100%; aspect-ratio:4/3; border-radius:3px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; }
  .pozicija-detail-page .poz-brez-thumb { max-width:100%; max-height:100%; display:block; }
  .pozicija-detail-page .poz-brez-title { font-size:0.8rem; font-weight:500; color:#333; word-wrap:break-word; }
  .pozicija-detail-page .poz-brez-actions { display:flex; flex-wrap:wrap; gap:4px; align-items:center; }

  .pozicija-detail-page .btn-ghost-sm, .pozicija-detail-page .btn-link-sm { border:none; background:none; padding:0; font-size:0.8rem; cursor:pointer; text-decoration:underline; color:#225caa; }
  .pozicija-detail-page .btn-ghost-sm:hover, .pozicija-detail-page .btn-link-sm:hover { color:#163e72; }

  .pozicija-detail-page .poz-meta { font-size:0.88rem; }
  .pozicija-detail-page .poz-meta-row { display:flex; justify-content:space-between; gap:8px; }
  .pozიცია-detail-page .poz-meta-label { color:#777; }
  .pozicija-detail-page .poz-meta-value { color:#222; }

  /* --- Paslauga layout --- */
  .pozicija-detail-page .paslauga-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 16px;
    align-items: start;
  }
  .pozicija-detail-page .paslauga-subblock {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px;
  }
  .pozicija-detail-page .paslauga-subtitle {
    margin: 2px 0 8px;
    font-size: 0.92rem;
    font-weight: 700;
  }
  .pozicija-detail-page .paslauga-top {
    margin-bottom: 10px;
  }
  .pozicija-detail-page .paslauga-notes {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid #e5e7eb;
  }

  @media (max-width: 900px) {
    .pozicija-detail-page .detail-header-bar { flex-direction:column; align-items:flex-start; }
    .pozicija-detail-page .poz-cards-grid { grid-template-columns:1fr; }
    .pozicija-detail-page .poz-card, .pozicija-detail-page .poz-card--full { grid-column:1 / -1; grid-row:auto; }
    .pozicija-detail-page .poz-card--client, .pozicija-detail-page .poz-card--detail, .pozicija-detail-page .poz-card--brez { grid-column:1 / -1; grid-row:auto; }

    .pozicija-detail-page .paslauga-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="poz-detail-container">
  <div class="detail-header-bar">
    <div class="detail-header-main">
      <h1 class="detail-header-title">
        {% if pozicija.poz_kodas %}{{ pozicija.poz_kodas }} – {% endif %}{{ pozicija.poz_pavad|default:"Be pavadinimo" }}
      </h1>
      <p class="detail-header-sub">
        Klientas: {{ pozicija.klientas|default:"—" }}{% if pozicija.projektas %} · Projektas: {{ pozicija.projektas }}{% endif %}
      </p>
    </div>
    <div class="detail-header-actions">
      <a href="{% url 'pozicijos:edit' pozicija.id %}" class="btn-action">Redaguoti</a>

      <a href="{% url 'pozicijos:pdf' pozicija.id %}?lang=lt" target="_blank" rel="noopener" class="btn-action btn-secondary">Pasiūlymas (LT)</a>
      <a href="{% url 'pozicijos:pdf' pozicija.id %}?lang=en" target="_blank" rel="noopener" class="btn-action btn-secondary">Pasiūlymas (EN)</a>

      <a href="{% url 'pozicijos:list' %}" class="btn-action">Atgal į sąrašą</a>
    </div>
  </div>

  <div class="poz-cards-grid">

    <section class="poz-card poz-card--client">
      <h2 class="poz-card-title">Klientas / projektas</h2>
      <div class="poz-fields">
        <div class="poz-field-row"><span class="poz-field-label">Klientas</span><span class="poz-field-value">{{ pozicija.klientas|default:"—" }}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Projektas</span><span class="poz-field-value">{{ pozicija.projektas|default:"—" }}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Pozicijos kodas</span><span class="poz-field-value">{{ pozicija.poz_kodas|default:"—" }}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Pozicijos pavadinimas</span><span class="poz-field-value">{{ pozicija.poz_pavad|default:"—" }}</span></div>
      </div>
    </section>

    <section class="poz-card poz-card--detail">
      <h2 class="poz-card-title">Detalė</h2>
      <div class="poz-fields">
        <div class="poz-field-row"><span class="poz-field-label">Metalas</span><span class="poz-field-value">{{ pozicija.metalas|default:"—" }}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Metalo storis</span><span class="poz-field-value">{% if metalo_storiai %}
{% for ms in metalo_storiai %}{{ ms.storis_mm }} mm{% if not forloop.last %}, {% endif %}{% endfor %}
{% else %}
{% if pozicija.metalo_storis is not None %}{{ pozicija.metalo_storis }} mm{% else %}—{% endif %}
{% endif %}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Plotas</span><span class="poz-field-value">{% if pozicija.plotas %}{{ pozicija.plotas }}{% else %}—{% endif %}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Svoris</span><span class="poz-field-value">{% if pozicija.svoris %}{{ pozicija.svoris }}{% else %}—{% endif %}</span></div>

        <div class="poz-field-row">
          <span class="poz-field-label">X (mm)</span>
          <span class="poz-field-value">{% if pozicija.x_mm is not None %}{{ pozicija.x_mm }}{% else %}—{% endif %}</span>
        </div>
        <div class="poz-field-row">
          <span class="poz-field-label">Y (mm)</span>
          <span class="poz-field-value">{% if pozicija.y_mm is not None %}{{ pozicija.y_mm }}{% else %}—{% endif %}</span>
        </div>
        <div class="poz-field-row">
          <span class="poz-field-label">Z (mm)</span>
          <span class="poz-field-value">{% if pozicija.z_mm is not None %}{{ pozicija.z_mm }}{% else %}—{% endif %}</span>
        </div>
        <div class="poz-field-row">
          <span class="poz-field-label">Matmenys (xyz)</span>
          <span class="poz-field-value">{% if pozicija.matmenys_xyz %}{{ pozicija.matmenys_xyz }}{% else %}—{% endif %}</span>
        </div>
      </div>
    </section>

    <section class="poz-card poz-card--brez">
      <h2 class="poz-card-title">Brėžiniai</h2>

      {% if breziniai %}
        <div class="poz-brez-grid">
          {% for brez in breziniai %}
            <div class="poz-brez-item">

              {% with e=brez.ext|lower %}
                {% if e == "stp" or e == "step" %}
                  <a href="{% url 'pozicijos:brezinys_3d' pozicija.id brez.id %}" class="poz-brez-thumb-wrap">
                    <img src="{% static 'pozicijos/img/icon-3d.png' %}" alt="3D" class="poz-brez-thumb">
                  </a>
                {% else %}
                  <a href="{{ brez.failas.url }}" target="_blank" class="poz-brez-thumb-wrap">
                    <img src="{{ brez.thumb_url|default:brez.failas.url }}" alt="{{ brez.pavadinimas|default:'Brėžinys' }}" class="poz-brez-thumb">
                  </a>
                {% endif %}
              {% endwith %}

              <div class="poz-brez-title">
                {{ brez.pavadinimas|default:brez.filename }}
              </div>

              <div class="poz-brez-actions">
                {% with e=brez.ext|lower %}
                  {% if e == "stp" or e == "step" %}
                    <a href="{% url 'pozicijos:brezinys_3d' pozicija.id brez.id %}" class="btn-ghost-sm">3D</a>
                  {% endif %}
                {% endwith %}

                <form method="post" action="{% url 'pozicijos:brezinys_delete' pozicija.id brez.id %}" onsubmit="return confirm('Ar tikrai šalinti brėžinį?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-link-sm">Šalinti</button>
                </form>
              </div>

            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="poz-empty">Nėra brėžinių.</p>
      {% endif %}

      <div class="poz-card-footer">
        <form method="post" action="{% url 'pozicijos:brezinys_upload' pozicija.id %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" name="failas" style="font-size:0.8rem;margin-right:6px;">
          <input type="text" name="pavadinimas" placeholder="Pavadinimas" style="font-size:0.8rem;margin-right:6px;">
          <button type="submit" class="btn-action">Įkelti brėžinį</button>
        </form>
      </div>
    </section>

    <section class="poz-card poz-card--full">
      <h2 class="poz-card-title">Paslauga</h2>
      <div class="poz-fields">

        <div class="paslauga-top">
          <div class="poz-field-row">
            <span class="poz-field-label">Paslaugos</span>
            <span class="poz-field-value">
              {% if pozicija.paslauga_ktl or pozicija.paslauga_miltai or pozicija.paslauga_paruosimas %}
                {% if pozicija.paslauga_ktl %}KTL{% endif %}
                {% if pozicija.paslauga_miltai %}{% if pozicija.paslauga_ktl %}, {% endif %}Miltai{% endif %}
                {% if pozicija.paslauga_paruosimas %}
                  {% if pozicija.paslauga_ktl or pozicija.paslauga_miltai %}, {% endif %}Paruošimas
                {% endif %}
              {% else %}
                —
              {% endif %}
            </span>
          </div>

          <div class="poz-field-row"><span class="poz-field-label">Paruošimas</span><span class="poz-field-value">{{ pozicija.paruosimas|default:"—" }}</span></div>
          <div class="poz-field-row"><span class="poz-field-label">Padengimas</span><span class="poz-field-value">{{ pozicija.padengimas|default:"—" }}</span></div>
          <div class="poz-field-row"><span class="poz-field-label">Padengimo standartas</span><span class="poz-field-value">{{ pozicija.padengimo_standartas|default:"—" }}</span></div>
          <div class="poz-field-row"><span class="poz-field-label">Partijų dydžiai</span><span class="poz-field-value">{{ pozicija.partiju_dydziai|default:"—" }}</span></div>
          <div class="poz-field-row"><span class="poz-field-label">Metiniai kiekiai</span><span class="poz-field-value">{{ pozicija.metiniai_kiekiai_display|default:"—" }}</span></div>
          <div class="poz-field-row"><span class="poz-field-label">Projekto laikotarpis</span><span class="poz-field-value">{{ pozicija.projekto_gyvavimo_display|default:"—" }}</span></div>
        </div>

        <div class="paslauga-grid">
          <div class="paslauga-subblock">
            <div class="paslauga-subtitle">
              KTL {% if pozicija.paslauga_ktl %}<span style="color:#16a34a; font-weight:600;">(Įjungta)</span>{% else %}<span style="color:#6b7280; font-weight:600;">(Išjungta)</span>{% endif %}
            </div>

            <div class="poz-field-row"><span class="poz-field-label">Kabinimo būdas</span><span class="poz-field-value">{{ pozicija.ktl_kabinimo_budas|default:"—" }}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Kabinimas rėme</span><span class="poz-field-value">{{ pozicija.ktl_kabinimas_reme_txt|default:"—" }}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Detalių kiekis rėme</span><span class="poz-field-value">{% if pozicija.ktl_detaliu_kiekis_reme %}{{ pozicija.ktl_detaliu_kiekis_reme }}{% else %}—{% endif %}</span></div>

            <div class="poz-field-row">
              <span class="poz-field-label">Faktinis kiekis rėme</span>
              {% with det=pozicija.ktl_detaliu_kiekis_reme fak=pozicija.ktl_faktinis_kiekis_reme %}
                {% if det and fak and det != fak %}
                  <span class="poz-field-value poz-field-value--alert">
                {% elif det and not fak %}
                  <span class="poz-field-value poz-field-value--alert">
                {% else %}
                  <span class="poz-field-value">
                {% endif %}
                  {% if fak %}{{ fak }}{% else %}—{% endif %}
                </span>
              {% endwith %}
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Detalių išdėstymas rėme (I×A×G)</span>
              <span class="poz-field-value">
                {% if pozicija.ktl_ilgis_mm or pozicija.ktl_aukstis_mm or pozicija.ktl_gylis_mm %}
                  {% if pozicija.ktl_ilgis_mm %}{{ pozicija.ktl_ilgis_mm|floatformat:0 }}{% else %}—{% endif %}
                  ×
                  {% if pozicija.ktl_aukstis_mm %}{{ pozicija.ktl_aukstis_mm|floatformat:0 }}{% else %}—{% endif %}
                  ×
                  {% if pozicija.ktl_gylis_mm %}{{ pozicija.ktl_gylis_mm|floatformat:0 }}{% else %}—{% endif %}
                {% else %}
                  —
                {% endif %}
              </span>
            </div>

            <div class="poz-field-row"><span class="poz-field-label">I×A×G sandauga</span><span class="poz-field-value">{% if pozicija.ktl_matmenu_sandauga_db %}{{ pozicija.ktl_matmenu_sandauga_db|floatformat:0 }}{% else %}—{% endif %}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Dangos storis (µm)</span><span class="poz-field-value">{% firstof pozicija.ktl_dangos_storis_display "—" %}</span></div>

            <div class="poz-field-row">
              <span class="poz-field-label">Kabinimo aprašymas</span>
              <span class="poz-field-value">{% if pozicija.ktl_kabinimas_aprasymas %}<div class="poz-notes-text">{{ pozicija.ktl_kabinimas_aprasymas|linebreaksbr }}</div>{% else %}—{% endif %}</span>
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Maskavimas (KTL)</span>
              <span class="poz-field-value">
                {% if mask_ktl %}
                  {% for m in mask_ktl %}
                    <div style="padding:6px 0; {% if not forloop.first %}border-top:1px solid #e5e7eb;{% endif %}">
                      <div><strong>Maskuotė:</strong> {{ m.maskuote|default:"—" }}</div>
                      <div><strong>Vietų kiekis:</strong> {% if m.vietu_kiekis is not None %}{{ m.vietu_kiekis }}{% else %}—{% endif %}</div>
                      <div><strong>Aprašymas:</strong> {% if m.aprasymas %}<span class="poz-notes-text">{{ m.aprasymas|linebreaksbr }}</span>{% else %}—{% endif %}</div>
                    </div>
                  {% endfor %}
                {% else %}
                  —
                {% endif %}
              </span>
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Pastabos (KTL)</span>
              <span class="poz-field-value">{% if pozicija.ktl_pastabos %}<div class="poz-notes-text">{{ pozicija.ktl_pastabos|linebreaksbr }}</div>{% else %}—{% endif %}</span>
            </div>
          </div>

          <div class="paslauga-subblock">
            <div class="paslauga-subtitle">
              Miltai {% if pozicija.paslauga_miltai %}<span style="color:#16a34a; font-weight:600;">(Įjungta)</span>{% else %}<span style="color:#6b7280; font-weight:600;">(Išjungta)</span>{% endif %}
            </div>

            <div class="poz-field-row"><span class="poz-field-label">Miltelių kodas</span><span class="poz-field-value">{{ pozicija.miltu_kodas|default:"—" }}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Miltelių spalva</span><span class="poz-field-value">{{ pozicija.miltu_spalva|default:"—" }}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Miltelių tiekėjas</span><span class="poz-field-value">{{ pozicija.miltu_tiekejas|default:"—" }}</span></div>
            <div class="poz-field-row"><span class="poz-field-label">Blizgumas</span><span class="poz-field-value">{{ pozicija.miltu_blizgumas|default:"—" }}</span></div>
            <div class="poz-field-row">
              <span class="poz-field-label">Miltelių kaina</span>
              <span class="poz-field-value">{% if pozicija.miltu_kaina is not None %}{{ pozicija.miltu_kaina }} €{% else %}—{% endif %}</span>
            </div>

            <div class="poz-field-row"><span class="poz-field-label">Dangos storis (µm)</span><span class="poz-field-value">{% firstof pozicija.miltai_dangos_storis_display "—" %}</span></div>

            <div class="poz-field-row">
              <span class="poz-field-label">Kiekis per valandą</span>
              <span class="poz-field-value">{% if pozicija.miltai_kiekis_per_valanda %}{{ pozicija.miltai_kiekis_per_valanda|floatformat:1 }}{% else %}—{% endif %}</span>
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Faktinis per valandą</span>
              <span class="poz-field-value">{% if pozicija.miltai_faktinis_per_valanda %}{{ pozicija.miltai_faktinis_per_valanda|floatformat:1 }}{% else %}—{% endif %}</span>
            </div>

            <div class="poz-field-row"><span class="poz-field-label">Detalių kiekis rėme</span><span class="poz-field-value">{% if pozicija.miltai_detaliu_kiekis_reme %}{{ pozicija.miltai_detaliu_kiekis_reme }}{% else %}—{% endif %}</span></div>

            <div class="poz-field-row">
              <span class="poz-field-label">Faktinis kiekis rėme</span>
              {% with det=pozicija.miltai_detaliu_kiekis_reme fak=pozicija.miltai_faktinis_kiekis_reme %}
                {% if det and fak and det != fak %}
                  <span class="poz-field-value poz-field-value--alert">
                {% elif det and not fak %}
                  <span class="poz-field-value poz-field-value--alert">
                {% else %}
                  <span class="poz-field-value">
                {% endif %}
                  {% if fak %}{{ fak }}{% else %}—{% endif %}
                </span>
              {% endwith %}
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Kabinimo aprašymas</span>
              <span class="poz-field-value">{% if pozicija.miltai_kabinimas_aprasymas %}<div class="poz-notes-text">{{ pozicija.miltai_kabinimas_aprasymas|linebreaksbr }}</div>{% else %}—{% endif %}</span>
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Maskavimas (Miltai)</span>
              <span class="poz-field-value">
                {% if mask_miltai %}
                  {% for m in mask_miltai %}
                    <div style="padding:6px 0; {% if not forloop.first %}border-top:1px solid #e5e7eb;{% endif %}">
                      <div><strong>Maskuotė:</strong> {{ m.maskuote|default:"—" }}</div>
                      <div><strong>Vietų kiekis:</strong> {% if m.vietu_kiekis is not None %}{{ m.vietu_kiekis }}{% else %}—{% endif %}</div>
                      <div><strong>Aprašymas:</strong> {% if m.aprasymas %}<span class="poz-notes-text">{{ m.aprasymas|linebreaksbr }}</span>{% else %}—{% endif %}</div>
                    </div>
                  {% endfor %}
                {% else %}
                  —
                {% endif %}
              </span>
            </div>

            <div class="poz-field-row">
              <span class="poz-field-label">Pastabos (Miltai)</span>
              <span class="poz-field-value">{% if pozicija.miltai_pastabos %}<div class="poz-notes-text">{{ pozicija.miltai_pastabos|linebreaksbr }}</div>{% else %}—{% endif %}</span>
            </div>
          </div>
        </div>

        <div class="paslauga-notes">
          <div class="poz-field-row">
            <span class="poz-field-label">Paslaugų pastabos</span>
            <span class="poz-field-value">
              {% if pozicija.paslaugu_pastabos %}
                <div class="poz-notes-text">{{ pozicija.paslaugu_pastabos|linebreaksbr }}</div>
              {% else %}
                —
              {% endif %}
            </span>
          </div>
        </div>

      </div>
    </section>

    <section class="poz-card">
      <h2 class="poz-card-title">Pakavimas</h2>
      <div class="poz-fields">
        <div class="poz-field-row"><span class="poz-field-label">Pakavimas</span><span class="poz-field-value">{{ pozicija.get_pakavimo_tipas_display|default:"—" }}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Aprašymas</span><span class="poz-field-value">{% if pozicija.pakavimas %}<div class="poz-notes-text">{{ pozicija.pakavimas|linebreaksbr }}</div>{% else %}—{% endif %}</span></div>
        <div class="poz-field-row"><span class="poz-field-label">Pastabos</span><span class="poz-field-value">{% if pozicija.instrukcija %}<div class="poz-notes-text">{{ pozicija.instrukcija|linebreaksbr }}</div>{% else %}—{% endif %}</span></div>
      </div>
    </section>

    <section class="poz-card">
      <h2 class="poz-card-title">Papildomos paslaugos</h2>
      <div class="poz-fields">
        <div class="poz-field-row"><span class="poz-field-label">Papildomos paslaugos</span><span class="poz-field-value">{{ pozicija.get_papildomos_paslaugos_display|default:"—" }}</span></div>
        <div class="poz-field-row">
          <span class="poz-field-label">Aprašymas</span>
          <span class="poz-field-value">
            {% if pozicija.papildomos_paslaugos == "taip" and pozicija.papildomos_paslaugos_aprasymas %}
              <div class="poz-notes-text">{{ pozicija.papildomos_paslaugos_aprasymas|linebreaksbr }}</div>
            {% else %}
              —
            {% endif %}
          </span>
        </div>
      </div>
    </section>

    <section class="poz-card">
      <h2 class="poz-card-title">Terminai</h2>
      <div class="poz-fields">
        <div class="poz-field-row">
          <span class="poz-field-label">Atlikimo terminas</span>
          <span class="poz-field-value">{% if pozicija.atlikimo_terminas %}{{ pozicija.atlikimo_terminas }} darbo dienos{% else %}—{% endif %}</span>
        </div>
      </div>
    </section>

    <section class="poz-card">
      <h2 class="poz-card-title">Testai / kokybė</h2>
      <div class="poz-fields">
        <div class="poz-field-row"><span class="poz-field-label">Testai / kokybė</span><span class="poz-field-value">{{ pozicija.testai_kokybe|default:"—" }}</span></div>
      </div>
    </section>

    <section class="poz-card poz-card--full">
      <h2 class="poz-card-title">Kaina</h2>

      {% if kainos_akt %}
        <div class="poz-price-table-wrapper">
          <table class="poz-price-table">
            <thead>
              <tr><th>Matas</th><th>Kiekis</th><th>Kaina</th><th>Galioja</th><th>Pastaba</th></tr>
            </thead>
            <tbody>
              {% for eil in kainos_akt %}
                <tr>
                  <td>{{ eil.matas|default:"—" }}</td>
                  <td>
                    {% if eil.yra_fiksuota %}
                      {% if eil.fiksuotas_kiekis %}{{ eil.fiksuotas_kiekis }} (fiksuotas){% else %}Fiksuotas kiekis{% endif %}
                    {% else %}
                      {% if eil.kiekis_nuo or eil.kiekis_iki %}
                        {% if eil.kiekis_nuo %}{{ eil.kiekis_nuo }}{% endif %}..{% if eil.kiekis_iki %}{{ eil.kiekis_iki }}{% endif %}
                      {% else %}
                        —
                      {% endif %}
                    {% endif %}
                  </td>
                  <td>{% if eil.kaina %}{{ eil.kaina }}&nbsp;€{% else %}—{% endif %}</td>
                  <td>
                    {% if eil.galioja_nuo or eil.galioja_iki %}
                      {% if eil.galioja_nuo %}{{ eil.galioja_nuo|date:"Y-m-d" }}{% endif %} – {% if eil.galioja_iki %}{{ eil.galioja_iki|date:"Y-m-d" }}{% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ eil.pastaba|default:"—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="poz-empty">Nėra aktualių kainų eilučių.</p>
      {% endif %}

      <div class="poz-card-footer">
        <a href="{% url 'pozicijos:kainos_list' pozicija.id %}" class="btn-action btn-secondary">Valdyti kainas</a>
      </div>
    </section>

    <section class="poz-card">
      <h2 class="poz-card-title">Sistemos informacija</h2>
      <div class="poz-meta">
        <div class="poz-meta-row"><span class="poz-meta-label">Sukurta</span><span class="poz-meta-value">{% if pozicija.created %}{{ pozicija.created|date:"Y-m-d H:i" }}{% else %}—{% endif %}</span></div>
        <div class="poz-meta-row"><span class="poz-meta-label">Atnaujinta</span><span class="poz-meta-value">{% if pozicija.updated %}{{ pozicija.updated|date:"Y-m-d H:i" }}{% else %}—{% endif %}</span></div>
        <div class="poz-meta-row"><span class="poz-meta-label">Brėžinių skaičius</span><span class="poz-meta-value">{{ breziniai|length }}</span></div>
      </div>
    </section>

    <section class="poz-card poz-card--full">
      <h2 class="poz-card-title">Pastabos</h2>
      {% if pozicija.pastabos %}
        <div class="poz-notes-text">{{ pozicija.pastabos|linebreaksbr }}</div>
      {% else %}
        <p class="poz-empty">Nėra pastabų.</p>
      {% endif %}
    </section>

  </div>
</div>
{% endblock %}
